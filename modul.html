<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modul Ajar - SD No. 3 Lukluk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .sidebar-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; color: #64748b; border-radius: 0.75rem; transition: all 0.2s; }
        .sidebar-item:hover { background-color: #f1f5f9; color: #2563eb; }
        .sidebar-active { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background-color: #eff6ff; color: #2563eb; border-radius: 0.75rem; font-weight: 600; border-right: 4px solid #2563eb; }
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.55); }
        .toast-enter { animation: toast-in 0.2s ease-out; }
        @keyframes toast-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex">

    <aside class="w-72 bg-white min-h-screen shadow-xl sticky top-0 p-6 flex flex-col">
        <div class="flex items-center space-x-3 mb-10">
            <img src="images/logo.png" alt="Logo" class="w-10 h-10">
            <span class="font-bold text-gray-800 uppercase tracking-tight">SISTEM ADMINISTRASI KELAS SD3</span>
        </div>
  <nav class="flex-1 px-4 space-y-1">
    <p class="px-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-2">Menu Utama</p>
    
    <a href="dashboard.html" class="sidebar-item flex items-center space-x-3 p-3 rounded-xl transition font-medium">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
        <span>Dashboard</span>
    </a>

    <a href="data-siswa.html" class="sidebar-item flex items-center space-x-3 p-3 text-gray-500 rounded-xl transition font-medium">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
        <span>Data Siswa</span>
    </a>

    <a href="data-user.html" class="sidebar-item flex items-center space-x-3 p-3 text-gray-500 rounded-xl transition font-medium">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
        <span>Data User</span>
    </a>

    <a href="daftar-nilai.html" class="sidebar-item flex items-center space-x-3 p-3 text-gray-500 rounded-xl transition font-medium">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
        <span>Daftar Nilai Harian</span>
    </a>

    <a href="daftar-hadir.html" class="sidebar-item flex items-center space-x-3 p-3 text-gray-500 rounded-xl transition font-medium">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
        <span>Daftar Hadir Harian</span>
    </a>

    <a href="jurnal.html" class="sidebar-item flex items-center space-x-3 p-3 text-gray-500 rounded-xl transition font-medium">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
        <span>Jurnal Mengajar</span>
    </a>

    <a href="konseling.html" class="sidebar-item flex items-center space-x-3 p-3 text-gray-500 rounded-xl transition font-medium">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
        <span>Buku Konseling</span>
    </a>

    <a href="modul.html" class="sidebar-active flex items-center space-x-3 p-3 rounded-xl transition font-medium">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
        <span>Modul Ajar</span>
    </a>

    <hr class="my-4 border-gray-100">

    <a href="index.html" class="flex items-center space-x-3 p-3 text-red-500 hover:bg-red-50 rounded-xl transition font-semibold">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
        <span>Keluar Sistem</span>
    </a>
</nav>
    </aside>

    <main class="flex-1 p-10">
        <header class="mb-8 space-y-5">
            <div class="flex flex-wrap gap-4 items-start justify-between">
                <div>
                <h1 class="text-2xl font-bold text-gray-800">Modul & Perangkat Ajar</h1>
                <p class="text-gray-500 text-sm">Pusat dokumen kurikulum Merdeka Kelas 4</p>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <button id="exportBtn" type="button" class="px-4 py-2 rounded-xl border border-slate-200 bg-white text-slate-700 font-semibold hover:bg-slate-50 transition">Export JSON</button>
                    <button id="importBtn" type="button" class="px-4 py-2 rounded-xl border border-slate-200 bg-white text-slate-700 font-semibold hover:bg-slate-50 transition">Import JSON</button>
                    <button id="resetBtn" type="button" class="px-4 py-2 rounded-xl border border-red-200 bg-red-50 text-red-600 font-semibold hover:bg-red-100 transition">Reset</button>
                    <button id="openUploadBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl font-bold shadow-lg shadow-blue-100 transition flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                        Upload Modul
                    </button>
                </div>
            </div>

            <div class="bg-white border border-slate-100 rounded-2xl p-4 shadow-sm">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <label class="md:col-span-2">
                        <span class="sr-only">Cari modul</span>
                        <input id="moduleSearch" type="text" placeholder="Cari judul atau bab modul..." class="w-full px-4 py-2 rounded-xl bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-300">
                    </label>
                    <label>
                        <span class="sr-only">Filter mapel</span>
                        <select id="subjectFilter" class="w-full px-4 py-2 rounded-xl bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-300">
                            <option value="all">Semua Mapel</option>
                            <option value="Matematika">Matematika</option>
                            <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                            <option value="IPAS">IPAS</option>
                            <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
                            <option value="Seni Budaya">Seni Budaya</option>
                        </select>
                    </label>
                </div>
                <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
                    <label>
                        <span class="sr-only">Urutkan modul</span>
                        <select id="sortBy" class="w-full px-4 py-2 rounded-xl bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-300">
                            <option value="newest">Urutkan: Terbaru</option>
                            <option value="oldest">Urutkan: Terlama</option>
                            <option value="title_asc">Urutkan: Judul A-Z</option>
                            <option value="title_desc">Urutkan: Judul Z-A</option>
                        </select>
                    </label>
                    <button id="clearFilterBtn" type="button" class="px-4 py-2 rounded-xl border border-slate-200 bg-white text-slate-700 font-semibold hover:bg-slate-50 transition">
                        Reset Pencarian
                    </button>
                    <p id="lastSyncText" class="text-xs text-slate-400 self-center md:text-right">Belum ada sinkronisasi.</p>
                </div>
                <div class="mt-4 flex items-center justify-between text-sm">
                    <p class="text-slate-500">Jumlah dokumen: <span id="moduleCount" class="font-semibold text-slate-700">0</span></p>
                    <p class="text-slate-400">Data tersimpan lokal di browser ini.</p>
                </div>
                <div id="subjectSummary" class="mt-3 flex flex-wrap gap-2"></div>
            </div>
        </header>

        <div id="moduleGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <section id="emptyState" class="hidden mt-10 bg-white border border-slate-100 rounded-3xl p-10 text-center shadow-sm">
            <div class="mx-auto w-14 h-14 rounded-2xl bg-slate-100 text-slate-500 flex items-center justify-center mb-4">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            </div>
            <h2 class="font-bold text-lg text-slate-800">Modul tidak ditemukan</h2>
            <p class="text-slate-500 mt-1">Coba ubah kata kunci pencarian atau filter mapel.</p>
        </section>
    </main>

    <div id="uploadModal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 modal-backdrop"></div>
        <div class="relative min-h-screen p-4 flex items-center justify-center">
            <div class="w-full max-w-2xl bg-white rounded-3xl shadow-2xl border border-slate-100">
                <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                    <div>
                        <h2 class="font-bold text-slate-800 text-lg">Upload Modul Baru</h2>
                        <p class="text-sm text-slate-500">Tambahkan metadata dokumen perangkat ajar.</p>
                    </div>
                    <button id="closeModalBtn" type="button" class="w-10 h-10 rounded-xl bg-slate-100 text-slate-500 hover:bg-slate-200 transition">
                        <span class="sr-only">Tutup modal</span>
                        <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>

                <form id="uploadForm" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label class="md:col-span-2">
                        <span class="text-sm font-semibold text-slate-700">Judul Modul</span>
                        <input name="title" required type="text" class="mt-1 w-full px-4 py-2 rounded-xl bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-300" placeholder="Contoh: Modul Ajar Matematika">
                    </label>
                    <label>
                        <span class="text-sm font-semibold text-slate-700">Mata Pelajaran</span>
                        <select name="subject" required class="mt-1 w-full px-4 py-2 rounded-xl bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-300">
                            <option value="">Pilih mapel</option>
                            <option value="Matematika">Matematika</option>
                            <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                            <option value="IPAS">IPAS</option>
                            <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
                            <option value="Seni Budaya">Seni Budaya</option>
                        </select>
                    </label>
                    <label>
                        <span class="text-sm font-semibold text-slate-700">Bab / Topik</span>
                        <input name="chapter" required type="text" class="mt-1 w-full px-4 py-2 rounded-xl bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-300" placeholder="Contoh: Bab 2: Pecahan">
                    </label>
                    <label>
                        <span class="text-sm font-semibold text-slate-700">Format File</span>
                        <select name="format" required class="mt-1 w-full px-4 py-2 rounded-xl bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-300">
                            <option value="">Pilih format</option>
                            <option value="PDF">PDF</option>
                            <option value="DOCX">DOCX</option>
                            <option value="PPTX">PPTX</option>
                        </select>
                    </label>
                    <label>
                        <span class="text-sm font-semibold text-slate-700">Ukuran (MB)</span>
                        <input name="size" required type="number" min="0.1" step="0.1" class="mt-1 w-full px-4 py-2 rounded-xl bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-300" placeholder="Contoh: 1.5">
                    </label>
                    <label class="md:col-span-2">
                        <span class="text-sm font-semibold text-slate-700">Link Dokumen</span>
                        <input name="url" type="url" class="mt-1 w-full px-4 py-2 rounded-xl bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-300" placeholder="https://...">
                    </label>
                    <div class="md:col-span-2 flex justify-end gap-3 pt-2">
                        <button id="cancelUploadBtn" type="button" class="px-5 py-2 rounded-xl bg-slate-100 text-slate-700 font-semibold hover:bg-slate-200 transition">Batal</button>
                        <button type="submit" class="px-5 py-2 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700 transition">Simpan Modul</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="toast" class="hidden fixed bottom-5 right-5 z-[60] bg-slate-900 text-white text-sm px-4 py-2 rounded-xl shadow-xl"></div>
    <input id="importFileInput" type="file" accept="application/json" class="hidden">

<script>
    const STORAGE_KEY = "sd3_modul_ajar_v1";
    const defaultModules = [
        {
            id: "mod-001",
            title: "Modul Ajar Matematika",
            subject: "Matematika",
            chapter: "Bab 1: Bilangan Cacah",
            format: "PDF",
            size: "2.4 MB",
            url: "#",
            createdAt: "2026-01-15T08:00:00.000Z"
        },
        {
            id: "mod-002",
            title: "Modul Ajar Bahasa Indonesia",
            subject: "Bahasa Indonesia",
            chapter: "Semester 2",
            format: "DOCX",
            size: "1.1 MB",
            url: "#",
            createdAt: "2026-01-11T08:00:00.000Z"
        }
    ];

    const moduleGrid = document.getElementById("moduleGrid");
    const moduleCount = document.getElementById("moduleCount");
    const moduleSearch = document.getElementById("moduleSearch");
    const subjectFilter = document.getElementById("subjectFilter");
    const sortBy = document.getElementById("sortBy");
    const clearFilterBtn = document.getElementById("clearFilterBtn");
    const subjectSummary = document.getElementById("subjectSummary");
    const lastSyncText = document.getElementById("lastSyncText");
    const emptyState = document.getElementById("emptyState");

    const openUploadBtn = document.getElementById("openUploadBtn");
    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const resetBtn = document.getElementById("resetBtn");
    const importFileInput = document.getElementById("importFileInput");
    const uploadModal = document.getElementById("uploadModal");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const cancelUploadBtn = document.getElementById("cancelUploadBtn");
    const uploadForm = document.getElementById("uploadForm");
    const toastEl = document.getElementById("toast");

    let modules = loadModules();
    let toastTimer = null;

    moduleSearch.addEventListener("input", renderModules);
    subjectFilter.addEventListener("change", renderModules);
    sortBy.addEventListener("change", renderModules);
    clearFilterBtn.addEventListener("click", function () {
        moduleSearch.value = "";
        subjectFilter.value = "all";
        sortBy.value = "newest";
        renderModules();
    });

    openUploadBtn.addEventListener("click", openUploadModal);
    exportBtn.addEventListener("click", exportModules);
    importBtn.addEventListener("click", function () {
        importFileInput.value = "";
        importFileInput.click();
    });
    resetBtn.addEventListener("click", resetModules);
    closeModalBtn.addEventListener("click", closeUploadModal);
    cancelUploadBtn.addEventListener("click", closeUploadModal);
    importFileInput.addEventListener("change", onImportFileSelected);
    uploadModal.addEventListener("click", function (event) {
        if (event.target === uploadModal || event.target.classList.contains("modal-backdrop")) {
            closeUploadModal();
        }
    });
    document.addEventListener("keydown", function (event) {
        if (event.key === "Escape" && !uploadModal.classList.contains("hidden")) {
            closeUploadModal();
        }
    });

    uploadForm.addEventListener("submit", function (event) {
        event.preventDefault();

        const data = new FormData(uploadForm);
        const sizeNumber = Number(data.get("size"));

        if (!Number.isFinite(sizeNumber) || sizeNumber <= 0) {
            alert("Ukuran file harus lebih dari 0.");
            return;
        }

        const newModule = {
            id: "mod-" + Date.now(),
            title: String(data.get("title") || "").trim(),
            subject: String(data.get("subject") || "").trim(),
            chapter: String(data.get("chapter") || "").trim(),
            format: String(data.get("format") || "").trim().toUpperCase(),
            size: sizeNumber.toFixed(1) + " MB",
            url: normalizeUrl(data.get("url")),
            createdAt: new Date().toISOString()
        };

        const duplicated = modules.some(function (item) {
            return (
                item.title.toLowerCase() === newModule.title.toLowerCase() &&
                item.subject.toLowerCase() === newModule.subject.toLowerCase() &&
                item.chapter.toLowerCase() === newModule.chapter.toLowerCase()
            );
        });
        if (duplicated) {
            alert("Modul dengan judul/mapel/bab yang sama sudah ada.");
            return;
        }

        modules.unshift(newModule);
        saveModules(modules);
        renderModules();
        uploadForm.reset();
        closeUploadModal();
        toast("Modul berhasil disimpan.");
    });

    renderModules();

    function loadModules() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return defaultModules.slice();
            const parsed = JSON.parse(raw);
            if (!Array.isArray(parsed)) return defaultModules.slice();
            return parsed
                .filter(Boolean)
                .map(function (item) {
                    return {
                        id: String(item.id || "mod-" + Date.now()),
                        title: String(item.title || "Tanpa Judul"),
                        subject: String(item.subject || "-"),
                        chapter: String(item.chapter || "-"),
                        format: String(item.format || "PDF"),
                        size: String(item.size || "0.0 MB"),
                        url: normalizeUrl(item.url),
                        createdAt: String(item.createdAt || new Date().toISOString())
                    };
                });
        } catch (error) {
            return defaultModules.slice();
        }
    }

    function saveModules(value) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(value));
    }

    function openUploadModal() {
        uploadModal.classList.remove("hidden");
        document.body.classList.add("overflow-hidden");
        const firstField = uploadForm.querySelector("input[name='title']");
        if (firstField) firstField.focus();
    }

    function closeUploadModal() {
        uploadModal.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
    }

    function renderModules() {
        const query = moduleSearch.value.trim().toLowerCase();
        const mapel = subjectFilter.value;
        const sortValue = sortBy.value;

        const filtered = modules
            .filter(function (item) {
                const matchesQuery =
                    item.title.toLowerCase().includes(query) ||
                    item.chapter.toLowerCase().includes(query);
                const matchesMapel = mapel === "all" || item.subject === mapel;
                return matchesQuery && matchesMapel;
            })
            .sort(function (a, b) {
                if (sortValue === "oldest") {
                    return String(a.createdAt).localeCompare(String(b.createdAt));
                }
                if (sortValue === "title_asc") {
                    return String(a.title).localeCompare(String(b.title), "id");
                }
                if (sortValue === "title_desc") {
                    return String(b.title).localeCompare(String(a.title), "id");
                }
                return String(b.createdAt).localeCompare(String(a.createdAt));
            });

        moduleCount.textContent = String(filtered.length);
        emptyState.classList.toggle("hidden", filtered.length > 0);
        renderSubjectSummary(filtered);
        updateLastSyncText();

        moduleGrid.innerHTML = filtered.map(function (item, index) {
            const accentClass = index % 2 === 0
                ? "bg-blue-50 text-blue-600 group-hover:bg-blue-600 group-hover:text-white"
                : "bg-orange-50 text-orange-600 group-hover:bg-orange-600 group-hover:text-white";

            return `
                <article class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm hover:shadow-md transition group flex flex-col">
                    <div class="w-12 h-12 rounded-2xl flex items-center justify-center mb-4 transition-colors ${accentClass}">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    </div>
                    <p class="text-xs font-semibold text-blue-600 mb-1">${escapeHtml(item.subject)}</p>
                    <h3 class="font-bold text-gray-800 mb-1">${escapeHtml(item.title)}</h3>
                    <p class="text-xs text-gray-400 mb-3 uppercase font-semibold tracking-wider">${escapeHtml(item.chapter)}</p>
                    <p class="text-xs text-slate-400">Diunggah: ${formatDate(item.createdAt)}</p>
                    <div class="flex items-center justify-between mt-auto pt-4 border-t border-gray-50 gap-4">
                        <span class="text-[10px] font-bold text-gray-400">${escapeHtml(item.format)} (${escapeHtml(item.size)})</span>
                        <div class="flex items-center gap-3">
                            <button type="button" data-id="${escapeHtml(item.id)}" class="delete-module text-xs text-red-500 font-semibold hover:underline">Hapus</button>
                            <a href="${escapeHtml(item.url)}" class="text-blue-600 text-sm font-bold hover:underline ${item.url === "#" ? "pointer-events-none opacity-50" : ""}" target="_blank" rel="noopener noreferrer">Buka File</a>
                        </div>
                    </div>
                </article>
            `;
        }).join("");

        const deleteButtons = moduleGrid.querySelectorAll(".delete-module");
        deleteButtons.forEach(function (btn) {
            btn.addEventListener("click", function () {
                const id = btn.getAttribute("data-id");
                if (!id) return;
                if (!confirm("Hapus modul ini?")) return;
                modules = modules.filter(function (item) { return item.id !== id; });
                saveModules(modules);
                renderModules();
                toast("Modul berhasil dihapus.");
            });
        });
    }

    function formatDate(isoText) {
        const dt = new Date(isoText);
        if (Number.isNaN(dt.getTime())) return "-";
        return dt.toLocaleDateString("id-ID", {
            day: "2-digit",
            month: "short",
            year: "numeric"
        });
    }

    function escapeHtml(value) {
        return String(value || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
    }

    function normalizeUrl(raw) {
        const value = String(raw || "").trim();
        if (!value) return "#";
        try {
            const parsed = new URL(value);
            if (parsed.protocol === "http:" || parsed.protocol === "https:") {
                return parsed.toString();
            }
            return "#";
        } catch (error) {
            return "#";
        }
    }

    function toast(message) {
        if (!toastEl) return;
        toastEl.textContent = message;
        toastEl.classList.remove("hidden");
        toastEl.classList.add("toast-enter");
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(function () {
            toastEl.classList.add("hidden");
            toastEl.classList.remove("toast-enter");
        }, 1800);
    }

    function renderSubjectSummary(rows) {
        const map = rows.reduce(function (acc, row) {
            const key = String(row.subject || "-");
            acc[key] = (acc[key] || 0) + 1;
            return acc;
        }, {});
        const entries = Object.keys(map).sort(function (a, b) {
            return a.localeCompare(b, "id");
        });
        if (!entries.length) {
            subjectSummary.innerHTML = "";
            return;
        }
        subjectSummary.innerHTML = entries.map(function (subject) {
            return `<span class="text-xs px-3 py-1 rounded-full bg-slate-100 text-slate-600">${escapeHtml(subject)}: ${map[subject]}</span>`;
        }).join("");
    }

    function updateLastSyncText() {
        if (!lastSyncText) return;
        lastSyncText.textContent = "Terakhir diperbarui: " + new Date().toLocaleString("id-ID");
    }

    function exportModules() {
        const payload = {
            exportedAt: new Date().toISOString(),
            total: modules.length,
            modules: modules
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const day = new Date().toISOString().slice(0, 10);
        a.href = url;
        a.download = "modul-ajar-" + day + ".json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        toast("Data modul berhasil diexport.");
    }

    function onImportFileSelected(event) {
        const file = event.target.files && event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function () {
            try {
                const text = String(reader.result || "");
                const parsed = JSON.parse(text);
                const rows = Array.isArray(parsed) ? parsed : parsed.modules;
                if (!Array.isArray(rows)) {
                    alert("Format file tidak valid. Gunakan file hasil export dari halaman ini.");
                    return;
                }
                const normalized = rows
                    .filter(Boolean)
                    .map(function (item, idx) {
                        const createdAt = String(item.createdAt || new Date().toISOString());
                        return {
                            id: String(item.id || "imp-" + Date.now() + "-" + idx),
                            title: String(item.title || "Tanpa Judul"),
                            subject: String(item.subject || "-"),
                            chapter: String(item.chapter || "-"),
                            format: String(item.format || "PDF").toUpperCase(),
                            size: String(item.size || "0.0 MB"),
                            url: normalizeUrl(item.url),
                            createdAt: createdAt
                        };
                    });

                modules = normalized;
                saveModules(modules);
                renderModules();
                toast("Import selesai: " + normalized.length + " modul.");
            } catch (error) {
                alert("Gagal membaca file JSON.");
            }
        };
        reader.readAsText(file, "utf-8");
    }

    function resetModules() {
        if (!confirm("Reset data modul ke data awal?")) return;
        modules = defaultModules.slice();
        saveModules(modules);
        renderModules();
        toast("Data modul dikembalikan ke default.");
    }
</script>

</body>
</html>
