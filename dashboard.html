<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SD No. 3 Lukluk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .sidebar-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; color: #64748b; border-radius: 0.75rem; transition: all 0.2s; }
        .sidebar-item:hover { background-color: #f1f5f9; color: #2563eb; }
        .sidebar-active { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background-color: #eff6ff; color: #2563eb; border-radius: 0.75rem; font-weight: 600; border-right: 4px solid #2563eb; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col md:flex-row">
    <aside class="w-full md:w-72 bg-white h-auto md:min-h-screen shadow-xl relative md:sticky top-0 p-4 md:p-6 flex flex-col z-10">
        <div class="flex items-center justify-between mb-4 md:mb-10">
            <div class="flex items-center space-x-3">
                <img src="images/logo.png" alt="Logo" class="w-10 h-10">
                <span class="font-bold text-gray-800 uppercase tracking-tight">SISTEM ADMINISTRASI KELAS SD3</span>
            </div>
            <button id="mobileMenuBtn" class="md:hidden p-2 text-slate-600 rounded-lg hover:bg-slate-100 focus:outline-none"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button>
        </div>
        <nav id="sidebarNav" class="hidden md:block flex-1 px-4 space-y-1">
            <p class="px-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-2">Menu Utama</p>
            <a href="dashboard.html" class="sidebar-active">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                <span>Dashboard</span>
            </a>
            <a href="data-siswa.html" class="sidebar-item">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                <span>Data Siswa</span>
            </a>
            <a href="data-user.html" class="sidebar-item">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                <span>Data User</span>
            </a>
            <a href="daftar-nilai.html" class="sidebar-item">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
                <span>Daftar Nilai Harian</span>
            </a>
            <a href="daftar-hadir.html" class="sidebar-item">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                <span>Daftar Hadir Harian</span>
            </a>
            <a href="jurnal.html" class="sidebar-item">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                <span>Jurnal Mengajar</span>
            </a>
            <a href="konseling.html" class="sidebar-item">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                <span>Buku Konseling</span>
            </a>
            <a href="modul.html" class="sidebar-item">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                <span>Modul Ajar</span>
            </a>
            <hr class="my-4 border-gray-100">
            <a href="index.html" class="flex items-center space-x-3 p-3 text-red-500 hover:bg-red-50 rounded-xl transition font-semibold">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a2 2 0 013-3h4a2 2 0 013 3v1"/></svg>
                <span>Keluar Sistem</span>
            </a>
        </nav>
    </aside>

    <main class="flex-1 p-4 md:p-10 w-full max-w-full">
        <header class="mb-8 flex flex-wrap items-start justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">Dashboard Sekolah</h1>
                <p class="text-slate-500 text-sm">Ringkasan operasional kelas 4 SD No. 3 Lukluk</p>
            </div>
            <div class="bg-white border border-slate-100 rounded-2xl px-4 py-3 shadow-sm">
                <p class="text-xs uppercase tracking-wide text-slate-400">Waktu Saat Ini</p>
                <p id="clockText" class="font-bold text-slate-700">-</p>
            </div>
        </header>

        <section class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h2 class="font-bold text-slate-800">Backup & Restore Data</h2>
                    <p class="text-sm text-slate-500 mt-1">Amankan data aplikasi ke file lokal (JSON).</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <input type="file" id="restoreInput" accept=".json" class="hidden">
                    <button id="localRestoreBtn" class="px-4 py-2 rounded-xl border border-slate-200 text-slate-600 font-bold text-sm hover:bg-slate-50 transition">Restore File</button>
                    <button id="localBackupBtn" class="px-4 py-2 rounded-xl bg-slate-100 text-slate-700 font-bold text-sm hover:bg-slate-200 transition">Download Backup</button>
                </div>
            </div>
        </section>

        <div id="absenceAlert" class="hidden bg-red-50 border border-red-100 rounded-3xl p-4 mb-6 flex items-start gap-4 shadow-sm">
            <div class="p-3 bg-red-100 rounded-2xl text-red-600 shrink-0">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
            </div>
            <div>
                <h3 class="font-bold text-red-800 text-lg">Perhatian: Absensi Siswa</h3>
                <p class="text-sm text-red-600 mb-2">Siswa berikut tidak hadir selama 3 hari aktif terakhir berturut-turut:</p>
                <ul id="absenceAlertList" class="text-sm text-red-700 list-disc list-inside font-medium space-y-1"></ul>
            </div>
        </div>

        <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
            <article class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Total Siswa</p>
                <p id="metricStudentsTotal" class="mt-2 text-3xl font-bold text-slate-800">0</p>
            </article>
            <article class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Siswa Aktif</p>
                <p id="metricStudentsActive" class="mt-2 text-3xl font-bold text-emerald-600">0</p>
            </article>
            <article class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">User Aktif</p>
                <p id="metricUsersActive" class="mt-2 text-3xl font-bold text-indigo-600">0</p>
            </article>
            <article class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Modul Tersedia</p>
                <p id="metricModulesTotal" class="mt-2 text-3xl font-bold text-blue-600">0</p>
            </article>
        </section>

        <section class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm mb-6">
            <h2 class="font-bold text-slate-800 mb-4">Statistik Kehadiran Bulan Ini</h2>
            <div class="h-64 w-full">
                <canvas id="attendanceChart"></canvas>
            </div>
        </section>

        <section class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <div class="xl:col-span-2 bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                    <h2 class="font-bold text-slate-800">Siswa Terbaru</h2>
                    <a href="data-siswa.html" class="text-sm font-semibold text-blue-600 hover:underline">Kelola Siswa</a>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 text-slate-500 uppercase text-xs tracking-wide">
                            <tr>
                                <th class="px-4 py-3 text-left">Nama</th>
                                <th class="px-4 py-3 text-left">NISN</th>
                                <th class="px-4 py-3 text-left">Kelas</th>
                                <th class="px-4 py-3 text-left">Status</th>
                            </tr>
                        </thead>
                        <tbody id="studentsPreviewBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
                <div id="studentsPreviewEmpty" class="hidden p-8 text-center text-slate-500">Belum ada data siswa.</div>
            </div>

            <div class="space-y-6">
                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-bold text-slate-800">Kalender Akademik</h2>
                        <div class="flex gap-1">
                            <button id="prevMonthBtn" class="p-1 hover:bg-slate-100 rounded-lg text-slate-500 transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                            <span id="calMonthYear" class="text-xs font-bold text-slate-600 self-center px-2"></span>
                            <button id="nextMonthBtn" class="p-1 hover:bg-slate-100 rounded-lg text-slate-500 transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center text-[10px] uppercase tracking-wide text-slate-400 font-bold mb-2"><div>Min</div><div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div></div>
                    <div id="calDays" class="grid grid-cols-7 gap-1 text-center text-sm text-slate-600"></div>
                </div>

                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm p-6">
                    <h2 class="font-bold text-slate-800 mb-4">Distribusi User</h2>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-slate-500">Admin</span>
                            <span id="roleAdminCount" class="font-bold text-slate-700">0</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-slate-500">Guru</span>
                            <span id="roleTeacherCount" class="font-bold text-slate-700">0</span>
                        </div>
                        <div class="pt-2">
                            <a href="data-user.html" class="inline-flex items-center text-sm font-semibold text-blue-600 hover:underline">Buka Data User</a>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm p-6">
                    <h2 class="font-bold text-slate-800 mb-4">Quick Access</h2>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <a href="daftar-hadir.html" class="px-3 py-2 rounded-xl bg-slate-50 text-slate-700 hover:bg-slate-100 transition">Presensi</a>
                        <a href="daftar-nilai.html" class="px-3 py-2 rounded-xl bg-slate-50 text-slate-700 hover:bg-slate-100 transition">Nilai</a>
                        <a href="jurnal.html" class="px-3 py-2 rounded-xl bg-slate-50 text-slate-700 hover:bg-slate-100 transition">Jurnal</a>
                        <a href="modul.html" class="px-3 py-2 rounded-xl bg-slate-50 text-slate-700 hover:bg-slate-100 transition">Modul</a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="toast" class="hidden fixed bottom-5 right-5 z-[60] bg-slate-900 text-white text-sm px-4 py-2 rounded-xl shadow-xl"></div>

    <script>
        const STUDENTS_KEY = "sd3_data_siswa_v1";
        const USERS_KEY = "sd3_data_user_v1";
        const MODULES_KEY = "sd3_modul_ajar_v1";
        const ATTENDANCE_KEY = "sd3_presensi_v2";
        const GRADE_KEY = "sd3_nilai_harian_v1";
        const JOURNAL_KEY = "sd3_jurnal_mengajar_v1";
        const COUNSEL_KEY = "sd3_buku_konseling_v1";
        const TP_KEY = "sd3_tp_master_v1";

        const ALL_KEYS = [STUDENTS_KEY, USERS_KEY, MODULES_KEY, ATTENDANCE_KEY, GRADE_KEY, JOURNAL_KEY, COUNSEL_KEY, TP_KEY];

        const defaultStudents = [
            { id: "STU-001", full_name: "Putu Ayu Lestari", nisn: "1234567001", class_name: "4A", is_active: true, created_at: "2026-01-10T07:00:00.000Z" },
            { id: "STU-002", full_name: "Kadek Budi Santosa", nisn: "1234567002", class_name: "4A", is_active: true, created_at: "2026-01-10T07:05:00.000Z" }
        ];

        const defaultUsers = [
            { id: "USR-ADMIN", username: "admin", full_name: "Administrator", role: "admin", is_active: true },
            { id: "USR-T001", username: "guru1", full_name: "Guru Kelas 4A", role: "teacher", is_active: true }
        ];

        const defaultModules = [
            { id: "MOD-001", title: "Modul Ajar Matematika" },
            { id: "MOD-002", title: "Modul Ajar Bahasa Indonesia" }
        ];

        const students = loadArray(STUDENTS_KEY, defaultStudents);
        const users = loadArray(USERS_KEY, defaultUsers);
        const modules = loadArray(MODULES_KEY, defaultModules);
        const attendances = loadArray(ATTENDANCE_KEY, []);

        let currentCalDate = new Date();
        let toastTimer = null;

        renderClock();
        setInterval(renderClock, 1000);
        renderMetrics();
        renderStudentPreview();
        renderChart();
        renderCalendar();
        checkConsecutiveAbsences();

        document.getElementById("prevMonthBtn").addEventListener("click", function() {
            currentCalDate.setMonth(currentCalDate.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById("nextMonthBtn").addEventListener("click", function() {
            currentCalDate.setMonth(currentCalDate.getMonth() + 1);
            renderCalendar();
        });

        // Backup Restore Events
        document.getElementById("localBackupBtn").addEventListener("click", downloadBackup);
        document.getElementById("localRestoreBtn").addEventListener("click", () => document.getElementById("restoreInput").click());
        document.getElementById("restoreInput").addEventListener("change", restoreBackup);

        function loadArray(key, fallback) {
            try {
                const raw = localStorage.getItem(key);
                if (!raw) return fallback.slice();
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed.filter(Boolean) : fallback.slice();
            } catch (error) {
                return fallback.slice();
            }
        }

        function renderClock() {
            const now = new Date();
            const text = now.toLocaleDateString("id-ID", {
                weekday: "long",
                day: "2-digit",
                month: "long",
                year: "numeric"
            }) + " - " + now.toLocaleTimeString("id-ID");
            document.getElementById("clockText").textContent = text;
        }

        function renderCalendar() {
            const year = currentCalDate.getFullYear();
            const month = currentCalDate.getMonth();
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            document.getElementById("calMonthYear").textContent = new Date(year, month).toLocaleDateString("id-ID", { month: 'long', year: 'numeric' });
            
            const daysContainer = document.getElementById("calDays");
            daysContainer.innerHTML = "";
            
            for (let i = 0; i < firstDay; i++) {
                daysContainer.innerHTML += `<div></div>`;
            }
            
            const today = new Date();
            const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;
            
            for (let i = 1; i <= daysInMonth; i++) {
                const isToday = isCurrentMonth && i === today.getDate();
                const classes = isToday ? "w-8 h-8 flex items-center justify-center rounded-full bg-blue-600 text-white font-bold mx-auto shadow-md shadow-blue-200" : "w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-50 mx-auto cursor-pointer transition text-slate-600";
                daysContainer.innerHTML += `<div class="${classes}">${i}</div>`;
            }
        }

        function checkConsecutiveAbsences() {
            const dates = [...new Set(attendances.map(function(a) { return a.date; }))].sort().reverse();
            
            if (dates.length < 3) return;

            const last3Days = dates.slice(0, 3);
            const alerts = [];

            students.forEach(function(s) {
                if (s.is_active === false) return;

                const records = last3Days.map(function(date) {
                    return attendances.find(function(a) { return a.date === date && a.student_id === s.id; });
                });

                const isAbsent3Days = records.every(function(r) {
                    return r && r.status !== 'Hadir';
                });

                if (isAbsent3Days) {
                    alerts.push(s.full_name);
                }
            });

            if (alerts.length > 0) {
                const alertBox = document.getElementById("absenceAlert");
                const alertList = document.getElementById("absenceAlertList");
                alertList.innerHTML = alerts.map(function(name) { return "<li>" + esc(name) + "</li>"; }).join("");
                alertBox.classList.remove("hidden");
            }
        }

        function renderMetrics() {
            const studentsTotal = students.length;
            const studentsActive = students.filter(function (item) { return item.is_active !== false; }).length;
            const usersActive = users.filter(function (item) { return item.is_active !== false; }).length;
            const modulesTotal = modules.length;
            const adminCount = users.filter(function (item) { return String(item.role || "").toLowerCase() === "admin"; }).length;
            const teacherCount = users.filter(function (item) { return String(item.role || "").toLowerCase() === "teacher"; }).length;

            document.getElementById("metricStudentsTotal").textContent = String(studentsTotal);
            document.getElementById("metricStudentsActive").textContent = String(studentsActive);
            document.getElementById("metricUsersActive").textContent = String(usersActive);
            document.getElementById("metricModulesTotal").textContent = String(modulesTotal);
            document.getElementById("roleAdminCount").textContent = String(adminCount);
            document.getElementById("roleTeacherCount").textContent = String(teacherCount);
        }

        function renderStudentPreview() {
            const body = document.getElementById("studentsPreviewBody");
            const empty = document.getElementById("studentsPreviewEmpty");
            const latest = students
                .slice()
                .sort(function (a, b) {
                    return String(b.created_at || "").localeCompare(String(a.created_at || ""));
                })
                .slice(0, 6);

            if (!latest.length) {
                body.innerHTML = "";
                empty.classList.remove("hidden");
                return;
            }

            empty.classList.add("hidden");
            body.innerHTML = latest.map(function (item) {
                const active = item.is_active !== false;
                const statusClass = active ? "bg-emerald-50 text-emerald-700" : "bg-slate-100 text-slate-500";
                const statusText = active ? "Aktif" : "Nonaktif";
                return `
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-3 font-semibold text-slate-800">${esc(item.full_name || "-")}</td>
                        <td class="px-4 py-3 text-slate-700">${esc(item.nisn || "-")}</td>
                        <td class="px-4 py-3 text-slate-700">${esc(item.class_name || "-")}</td>
                        <td class="px-4 py-3"><span class="text-xs px-2 py-1 rounded-full ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            }).join("");
        }

        function renderChart() {
            const ctx = document.getElementById('attendanceChart');
            if (!ctx) return;

            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            const labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
            const dataHadir = new Array(daysInMonth).fill(0);
            const dataSakit = new Array(daysInMonth).fill(0);
            const dataIzin = new Array(daysInMonth).fill(0);
            const dataAlpha = new Array(daysInMonth).fill(0);

            attendances.forEach(function(a) {
                const d = new Date(a.date);
                if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                    const day = d.getDate() - 1;
                    if (a.status === 'Hadir') dataHadir[day]++;
                    else if (a.status === 'Sakit') dataSakit[day]++;
                    else if (a.status === 'Izin') dataIzin[day]++;
                    else if (a.status === 'Alpha') dataAlpha[day]++;
                }
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Hadir', data: dataHadir, backgroundColor: '#10b981', borderRadius: 4 },
                        { label: 'Sakit', data: dataSakit, backgroundColor: '#3b82f6', borderRadius: 4 },
                        { label: 'Izin', data: dataIzin, backgroundColor: '#eab308', borderRadius: 4 },
                        { label: 'Alpha', data: dataAlpha, backgroundColor: '#ef4444', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } }
                    },
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // --- Backup & Restore Logic ---

        function getBackupData() {
            const data = {};
            ALL_KEYS.forEach(key => {
                const val = localStorage.getItem(key);
                if (val) data[key] = JSON.parse(val);
            });
            return {
                timestamp: new Date().toISOString(),
                app: "SD3_ADMIN",
                version: "1.0",
                data: data
            };
        }

        function downloadBackup() {
            const data = getBackupData();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `backup-sd3-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            toast("Backup berhasil didownload.");
        }

        function restoreBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (json.app !== "SD3_ADMIN" || !json.data) throw new Error("Format file tidak valid.");
                    
                    if (!confirm(`Restore data dari tanggal ${new Date(json.timestamp).toLocaleString()}? Data saat ini akan ditimpa.`)) return;

                    Object.keys(json.data).forEach(key => {
                        localStorage.setItem(key, JSON.stringify(json.data[key]));
                    });
                    toast("Data berhasil direstore. Refreshing...");
                    setTimeout(() => location.reload(), 1500);
                } catch (err) {
                    alert("Gagal restore: " + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = "";
        }

        function toast(message) {
            const el = document.getElementById("toast");
            if (!el) return;
            el.textContent = message;
            el.classList.remove("hidden");
            el.classList.add("toast-enter");
            if (toastTimer) clearTimeout(toastTimer);
            toastTimer = setTimeout(function () {
                el.classList.add("hidden");
                el.classList.remove("toast-enter");
            }, 2500);
        }

        function esc(value) {
            return String(value || "")
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        document.getElementById('mobileMenuBtn').addEventListener('click', function() {
            document.getElementById('sidebarNav').classList.toggle('hidden');
        });
    </script>
</body>
</html>
