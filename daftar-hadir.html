<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daftar Hadir - SD No. 3 Lukluk</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; }
    .sidebar-item { display: block; padding: .6rem .75rem; border-radius: .75rem; color: #64748b; }
    .sidebar-item:hover { background: #f1f5f9; color: #2563eb; }
    .sidebar-active { background: #eff6ff; color: #2563eb; font-weight: 700; border-right: 4px solid #2563eb; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen flex">
  <aside class="w-72 bg-white min-h-screen shadow-xl sticky top-0 p-6 flex flex-col">
    <div class="flex items-center space-x-3 mb-10">
        <img src="images/logo.png" alt="Logo" class="w-10 h-10">
        <span class="font-bold text-gray-800 uppercase tracking-tight">SISTEM ADMINISTRASI KELAS SD3</span>
    </div>
    <nav class="space-y-1 text-sm">
      <a href="dashboard.html" class="sidebar-item">Dashboard</a>
      <a href="data-siswa.html" class="sidebar-item">Data Siswa</a>
      <a href="data-user.html" class="sidebar-item">Data User</a>
      <a href="daftar-nilai.html" class="sidebar-item">Daftar Nilai Harian</a>
      <a href="daftar-hadir.html" class="sidebar-item sidebar-active">Daftar Hadir Harian</a>
      <a href="jurnal.html" class="sidebar-item">Jurnal Mengajar</a>
      <a href="konseling.html" class="sidebar-item">Buku Konseling</a>
      <a href="modul.html" class="sidebar-item">Modul Ajar</a>
      <a href="index.html" class="sidebar-item text-red-500">Keluar Sistem</a>
    </nav>
  </aside>

  <main class="flex-1 p-8">
    <header class="mb-6 flex flex-wrap justify-between gap-2">
      <div>
        <h1 class="text-2xl font-bold text-slate-800">Presensi Masuk/Pulang</h1>
        <p id="dateText" class="text-sm text-slate-500"></p>
      </div>
      <div class="flex gap-2">
        <button id="bulkWaBtn" class="px-4 py-2 rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-700 font-semibold hover:bg-emerald-100 transition">WA Belum Absen</button>
        <button id="exportBtn" class="px-4 py-2 rounded-xl border border-slate-200 bg-white text-slate-700 font-semibold">Export Excel</button>
      </div>
    </header>

    <section class="bg-white border border-slate-100 rounded-2xl p-4 shadow-sm mb-5 grid grid-cols-1 md:grid-cols-4 gap-3">
      <label><span class="text-xs font-bold text-slate-400 uppercase">Tanggal</span><input id="attendanceDate" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 text-sm"></label>
      <label>
        <span class="text-xs font-bold text-slate-400 uppercase">Status</span>
        <select id="statusFilter" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 text-sm">
          <option value="all">Semua</option>
          <option value="Hadir">Hadir</option>
          <option value="Sakit">Sakit</option>
          <option value="Izin">Izin</option>
          <option value="Alpha">Alpha</option>
          <option value="Belum Absen">Belum Absen</option>
        </select>
      </label>
      <label class="md:col-span-2"><span class="text-xs font-bold text-slate-400 uppercase">Cari Siswa</span><input id="searchInput" type="text" placeholder="Nama / NISN..." class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 text-sm"></label>
    </section>

    <section class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-slate-50 text-slate-500 uppercase text-xs tracking-wide">
            <tr>
              <th class="px-4 py-3 text-left">Nama</th>
              <th class="px-4 py-3 text-left">NISN</th>
              <th class="px-4 py-3 text-left">Status</th>
              <th class="px-4 py-3 text-left">Jam Masuk</th>
              <th class="px-4 py-3 text-left">Jam Pulang</th>
              <th class="px-4 py-3 text-left">Catatan</th>
              <th class="px-4 py-3 text-right">Aksi</th>
            </tr>
          </thead>
          <tbody id="rows" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>
      <div id="emptyState" class="hidden p-8 text-center text-slate-500">Data siswa belum tersedia.</div>
    </section>
  </main>

  <div id="toast" class="hidden fixed bottom-5 right-5 bg-slate-900 text-white text-sm px-4 py-2 rounded-xl shadow-xl z-50"></div>

  <div id="editModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
      <div class="p-4 border-b border-slate-100 flex justify-between items-center">
        <h3 class="font-bold text-slate-800">Edit Presensi</h3>
        <button id="closeEditModalBtn" class="text-slate-400 hover:text-slate-600 text-xl leading-none">&times;</button>
      </div>
      <form id="editForm" class="p-4 space-y-4">
        <input type="hidden" id="editStudentId">
        <div>
          <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Siswa</label>
          <input type="text" id="editStudentName" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-slate-600 font-semibold" readonly>
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Status</label>
          <select id="editStatus" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white">
            <option value="Hadir">Hadir</option>
            <option value="Izin">Izin</option>
            <option value="Sakit">Sakit</option>
            <option value="Alpha">Alpha</option>
            <option value="Belum Absen">Belum Absen</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Jam Masuk</label><input type="time" step="1" id="editCheckIn" class="w-full px-3 py-2 rounded-xl border border-slate-200"></div>
          <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Jam Pulang</label><input type="time" step="1" id="editCheckOut" class="w-full px-3 py-2 rounded-xl border border-slate-200"></div>
        </div>
        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Catatan</label><textarea id="editNotes" rows="3" class="w-full px-3 py-2 rounded-xl border border-slate-200"></textarea></div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" id="cancelEditBtn" class="px-4 py-2 rounded-xl border border-slate-200 text-slate-600 font-semibold hover:bg-slate-50">Batal</button>
          <button type="submit" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700 shadow-lg shadow-blue-100">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <div id="bulkWaModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
      <div class="p-4 border-b border-slate-100 flex justify-between items-center">
        <h3 class="font-bold text-slate-800">Kirim WA - Belum Absen</h3>
        <button id="closeBulkWaModalBtn" class="text-slate-400 hover:text-slate-600 text-xl leading-none">&times;</button>
      </div>
      <div class="p-4 overflow-y-auto flex-1">
        <p class="text-sm text-slate-500 mb-4">Daftar siswa yang belum melakukan presensi pada tanggal <span id="bulkWaDate" class="font-bold text-slate-700"></span>.</p>
        <table class="w-full text-sm text-left">
          <thead class="bg-slate-50 text-slate-500 font-semibold">
            <tr>
              <th class="px-3 py-2">Nama Siswa</th>
              <th class="px-3 py-2">Orang Tua</th>
              <th class="px-3 py-2 text-right">Aksi</th>
            </tr>
          </thead>
          <tbody id="bulkWaRows" class="divide-y divide-slate-100"></tbody>
        </table>
        <div id="bulkWaEmpty" class="hidden text-center py-8 text-slate-500">Semua siswa sudah absen atau tidak ada data.</div>
      </div>
    </div>
  </div>

  <script>
    const STUDENT_KEY = "sd3_data_siswa_v1";
    const ATT_KEY = "sd3_presensi_v2";
    const defaultStudents = [
      { id: "STU-001", nisn: "1234567001", full_name: "Putu Ayu Lestari", parent_wa: "081234567001", is_active: true },
      { id: "STU-002", nisn: "1234567002", full_name: "Kadek Budi Santosa", parent_wa: "081234567002", is_active: true }
    ];

    const el = {
      date: document.getElementById("attendanceDate"),
      statusFilter: document.getElementById("statusFilter"),
      dateText: document.getElementById("dateText"),
      search: document.getElementById("searchInput"),
      exportBtn: document.getElementById("exportBtn"),
      bulkWaBtn: document.getElementById("bulkWaBtn"),
      rows: document.getElementById("rows"),
      empty: document.getElementById("emptyState"),
      toast: document.getElementById("toast"),
      editModal: document.getElementById("editModal"),
      editForm: document.getElementById("editForm"),
      closeEditModalBtn: document.getElementById("closeEditModalBtn"),
      cancelEditBtn: document.getElementById("cancelEditBtn"),
      editStudentId: document.getElementById("editStudentId"),
      editStudentName: document.getElementById("editStudentName"),
      editStatus: document.getElementById("editStatus"),
      editCheckIn: document.getElementById("editCheckIn"),
      editCheckOut: document.getElementById("editCheckOut"),
      editNotes: document.getElementById("editNotes"),
      bulkWaModal: document.getElementById("bulkWaModal"),
      closeBulkWaModalBtn: document.getElementById("closeBulkWaModalBtn"),
      bulkWaRows: document.getElementById("bulkWaRows"),
      bulkWaDate: document.getElementById("bulkWaDate"),
      bulkWaEmpty: document.getElementById("bulkWaEmpty")
    };

    let toastTimer = null;
    const students = loadArray(STUDENT_KEY, defaultStudents).filter(function (s) { return s.is_active !== false; });
    let attendances = loadArray(ATT_KEY, []);

    el.date.value = dateKey(new Date());
    refreshDateText();
    render();

    el.date.addEventListener("change", function () { refreshDateText(); render(); });
    el.statusFilter.addEventListener("change", render);
    el.search.addEventListener("input", render);
    el.exportBtn.addEventListener("click", exportExcel);
    el.bulkWaBtn.addEventListener("click", openBulkWaModal);
    el.closeEditModalBtn.addEventListener("click", closeEditModal);
    el.cancelEditBtn.addEventListener("click", closeEditModal);
    el.editForm.addEventListener("submit", saveEdit);
    el.closeBulkWaModalBtn.addEventListener("click", closeBulkWaModal);

    function loadArray(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback.slice();
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed.filter(Boolean) : fallback.slice();
      } catch (e) { return fallback.slice(); }
    }
    function persistAtt() { localStorage.setItem(ATT_KEY, JSON.stringify(attendances)); }
    function dateKey(d) { const x = new Date(d); return x.getFullYear() + "-" + String(x.getMonth() + 1).padStart(2, "0") + "-" + String(x.getDate()).padStart(2, "0"); }
    function esc(v) { return String(v || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;"); }
    function uid(prefix) { return prefix + "-" + Date.now().toString(36).toUpperCase() + "-" + Math.random().toString(36).slice(2, 6).toUpperCase(); }
    function findRow(date, sid) { return attendances.find(function (a) { return a.date === date && a.student_id === sid; }); }
    function upsertRow(row) { const i = attendances.findIndex(function (a) { return a.date === row.date && a.student_id === row.student_id; }); if (i >= 0) attendances[i] = row; else attendances.push(row); }

    function refreshDateText() {
      const value = el.date.value || dateKey(new Date());
      const d = new Date(value + "T00:00:00");
      el.dateText.textContent = d.toLocaleDateString("id-ID", { weekday: "long", day: "2-digit", month: "long", year: "numeric" });
    }

    function studentName(s) { return String((s && (s.full_name || s.name)) || "Tanpa Nama").trim(); }
    function studentNisn(s) { return String((s && (s.nisn || s.nis)) || "").trim(); }
    function studentWa(s) { return String((s && (s.parent_wa || s.wa)) || "").trim(); }

    function getFilteredStudents() {
      const query = String(el.search.value || "").trim().toLowerCase();
      return students
        .filter(function (s) {
          const nm = studentName(s).toLowerCase();
          const ns = studentNisn(s).toLowerCase();
          return !query || nm.includes(query) || ns.includes(query);
        })
        .sort(function (a, b) { return studentName(a).localeCompare(studentName(b), "id"); });
    }

    function render() {
      const date = el.date.value || dateKey(new Date());
      const statusFilter = el.statusFilter.value;
      let list = getFilteredStudents();
      const byDate = attendances.filter(function (a) { return a.date === date; });
      const map = new Map(byDate.map(function (a) { return [a.student_id, a]; }));

      if (statusFilter !== "all") {
        list = list.filter(function (s) {
          const row = map.get(s.id) || {};
          const status = row.status || "Belum Absen";
          return status === statusFilter;
        });
      }

      if (!students.length) {
        el.rows.innerHTML = "";
        el.empty.textContent = "Data siswa belum tersedia.";
        el.empty.classList.remove("hidden");
        return;
      }

      if (!list.length) {
        el.rows.innerHTML = "";
        el.empty.textContent = "Siswa tidak ditemukan.";
        el.empty.classList.remove("hidden");
        return;
      }

      el.empty.classList.add("hidden");
      el.rows.innerHTML = list.map(function (s) {
        const row = map.get(s.id) || {};
        const status = row.status || "Belum Absen";
        const statusClass = status === "Hadir" ? "bg-emerald-50 text-emerald-700" : "bg-slate-100 text-slate-500";
        let statusClass = "bg-slate-100 text-slate-500";
        if (status === "Hadir") statusClass = "bg-emerald-100 text-emerald-700";
        else if (status === "Sakit") statusClass = "bg-blue-100 text-blue-700";
        else if (status === "Izin") statusClass = "bg-yellow-100 text-yellow-700";
        else if (status === "Alpha") statusClass = "bg-red-100 text-red-700";

        return `
          <tr class="hover:bg-slate-50">
            <td class="px-4 py-3 font-semibold text-slate-800">${esc(studentName(s))}</td>
            <td class="px-4 py-3 text-slate-700">${esc(studentNisn(s) || "-")}</td>
            <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass}">${esc(status)}</span></td>
            <td class="px-4 py-3 text-slate-700">${esc(row.check_in || "-")}</td>
            <td class="px-4 py-3 text-slate-700">${esc(row.check_out || "-")}</td>
            <td class="px-4 py-3 text-slate-700">${esc(row.notes || "-")}</td>
            <td class="px-4 py-3 text-right">
              <button class="edit-btn text-blue-600 hover:text-blue-800 font-semibold text-xs bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded-lg transition" data-sid="${esc(s.id)}">Edit</button>
              <button class="wa-btn text-emerald-600 hover:text-emerald-800 font-semibold text-xs bg-emerald-50 hover:bg-emerald-100 px-3 py-1.5 rounded-lg transition ml-1" data-sid="${esc(s.id)}" title="Kirim WA">
                <svg class="w-4 h-4 inline-block" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.536 0 1.52 1.115 2.988 1.264 3.186.149.198 2.19 3.349 5.273 4.695 2.678 1.171 3.224.938 3.819.879.595-.059 1.905-.783 2.173-1.538.268-.756.268-1.398.188-1.538-.08-.149-.297-.223-.594-.372zM12 2.163c5.421 0 9.828 4.409 9.828 9.828 0 1.734-.451 3.359-1.244 4.784l.828 3.076-3.158-.816c-1.366.743-2.912 1.17-4.554 1.17-5.421 0-9.828-4.409-9.828-9.828 0-5.418 4.407-9.828 9.828-9.828zm0-2.163C5.373 0 0 5.373 0 12c0 2.123.55 4.109 1.514 5.856l-1.514 5.528 5.654-1.482C7.396 23.195 9.616 24 12 24c6.627 0 12-5.373 12-12S18.627 0 12 0z"/></svg>
              </button>
            </td>
          </tr>
        `;
      }).join("");

      el.rows.querySelectorAll(".edit-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          openEditModal(btn.getAttribute("data-sid"));
        });
      });

      el.rows.querySelectorAll(".wa-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          sendWa(btn.getAttribute("data-sid"));
        });
      });
    }

    function exportExcel() {
      if (typeof XLSX === "undefined") {
        toast("Library Excel tidak tersedia.");
        return;
      }
      const date = el.date.value || dateKey(new Date());
      const list = getFilteredStudents();
      if (!list.length) {
        toast("Tidak ada data untuk diekspor.");
        return;
      }
      const rows = list.map(function (s, i) {
        const row = findRow(date, s.id) || {};
        return {
          No: i + 1,
          Tanggal: date,
          NISN: studentNisn(s) || "-",
          Nama: studentName(s),
          Status: row.status || "Belum Absen",
          Jam_Masuk: row.check_in || "",
          Jam_Pulang: row.check_out || "",
          Catatan: row.notes || "",
          WA_Ortu: studentWa(s) || row.parent_wa || "",
          Sumber_Masuk: row.source_in || "",
          Sumber_Pulang: row.source_out || ""
        };
      });

      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Presensi");
      XLSX.writeFile(wb, "presensi-" + date + ".xlsx");
      toast("Export Excel berhasil.");
      if (window.XLSX && typeof window.XLSX.utils !== "undefined") {
        const ws = window.XLSX.utils.json_to_sheet(rows);
        const wb = window.XLSX.utils.book_new();
        window.XLSX.utils.book_append_sheet(wb, ws, "Presensi");
        window.XLSX.writeFile(wb, "presensi-" + date + ".xlsx");
        toast("Export Excel berhasil.");
      } else {
        // Fallback to CSV if XLSX library is not loaded
        const headers = Object.keys(rows[0]);
        const csv = [headers.join(",")].concat(rows.map(r => headers.map(h => `"${String(r[h] || "").replace(/"/g, '""')}"`).join(","))).join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "presensi-" + date + ".csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        toast("Library Excel gagal, export ke CSV.");
      }
    }

    function openEditModal(sid) {
      const s = students.find(function (x) { return x.id === sid; });
      if (!s) return;
      const date = el.date.value || dateKey(new Date());
      const row = findRow(date, sid) || { status: "Belum Absen", check_in: "", check_out: "", notes: "" };

      el.editStudentId.value = sid;
      el.editStudentName.value = studentName(s);
      el.editStatus.value = row.status || "Belum Absen";
      el.editCheckIn.value = row.check_in || "";
      el.editCheckOut.value = row.check_out || "";
      el.editNotes.value = row.notes || "";

      el.editModal.classList.remove("hidden");
    }

    function closeBulkWaModal() {
      el.bulkWaModal.classList.add("hidden");
    }

    function openBulkWaModal() {
      const date = el.date.value || dateKey(new Date());
      el.bulkWaDate.textContent = date;
      
      const list = students.filter(function(s) {
        const row = findRow(date, s.id);
        const status = row ? row.status : "Belum Absen";
        return status === "Belum Absen";
      }).sort(function(a, b) { return studentName(a).localeCompare(studentName(b)); });

      if (list.length === 0) {
        el.bulkWaRows.innerHTML = "";
        el.bulkWaEmpty.classList.remove("hidden");
      } else {
        el.bulkWaEmpty.classList.add("hidden");
        el.bulkWaRows.innerHTML = list.map(function(s) {
          return `
            <tr class="hover:bg-slate-50">
              <td class="px-3 py-2 font-medium text-slate-800">${esc(studentName(s))}</td>
              <td class="px-3 py-2 text-slate-600">${esc(s.parent_name || "-")} <span class="text-xs text-slate-400">(${esc(studentWa(s))})</span></td>
              <td class="px-3 py-2 text-right">
                <button class="bulk-send-btn px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-xs font-bold hover:bg-emerald-700 transition shadow-sm" data-sid="${esc(s.id)}">
                  Kirim WA
                </button>
              </td>
            </tr>
          `;
        }).join("");

        el.bulkWaRows.querySelectorAll(".bulk-send-btn").forEach(function(btn) {
          btn.addEventListener("click", function() {
            sendWa(btn.getAttribute("data-sid"));
          });
        });
      }
      el.bulkWaModal.classList.remove("hidden");
    }

    function closeEditModal() {
      el.editModal.classList.add("hidden");
    }

    function saveEdit(e) {
      e.preventDefault();
      const sid = el.editStudentId.value;
      const date = el.date.value || dateKey(new Date());
      const s = students.find(function (x) { return x.id === sid; });
      if (!s) return;

      let row = findRow(date, sid);
      if (!row) {
        row = {
          id: uid("ATT"),
          date: date,
          student_id: sid,
          student_name: studentName(s),
          nisn: studentNisn(s),
          parent_wa: studentWa(s),
          created_at: new Date().toISOString()
        };
      }

      row.status = el.editStatus.value;
      row.check_in = el.editCheckIn.value;
      row.check_out = el.editCheckOut.value;
      row.notes = el.editNotes.value;
      row.updated_at = new Date().toISOString();

      upsertRow(row);
      persistAtt();
      render();
      closeEditModal();
      toast("Data presensi diperbarui.");
    }

    function sendWa(sid) {
      const s = students.find(function (x) { return x.id === sid; });
      if (!s) return;
      
      const date = el.date.value || dateKey(new Date());
      const row = findRow(date, sid) || {};
      const status = row.status || "Belum Absen";
      const checkIn = row.check_in || "-";
      const checkOut = row.check_out || "-";
      const notes = row.notes || "-";
      
      let phone = String(s.parent_wa || "").replace(/\D/g, "");
      if (!phone) {
        toast("Nomor WA orang tua tidak tersedia.");
        return;
      }
      if (phone.startsWith("0")) phone = "62" + phone.slice(1);
      
      const msg = `Yth. Orang Tua/Wali ${s.full_name || ""},\n\nBerikut status kehadiran siswa pada tanggal ${date}:\nStatus: ${status}\nJam Masuk: ${checkIn}\nJam Pulang: ${checkOut}\nCatatan: ${notes}\n\nTerima kasih.`;
      window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, "_blank");
    }

    function toast(message) {
      if (!el.toast) return;
      el.toast.textContent = String(message || "");
      el.toast.classList.remove("hidden");
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(function () {
        el.toast.classList.add("hidden");
      }, 2000);
    }
  </script>
</body>
</html>
