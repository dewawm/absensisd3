<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rekap Kehadiran Harian - SD No. 3 Lukluk</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: "Plus Jakarta Sans", sans-serif; }
    .sidebar-item { display: block; padding: .6rem .75rem; border-radius: .75rem; color: #64748b; }
    .sidebar-item:hover { background: #f1f5f9; color: #2563eb; }
    .sidebar-active { background: #eff6ff; color: #2563eb; font-weight: 700; border-right: 4px solid #2563eb; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen flex">
  <aside class="w-72 bg-white min-h-screen shadow-xl sticky top-0 p-6">
    <div class="mb-8 font-bold text-gray-800 uppercase">SISTEM ADMINISTRASI KELAS SD3</div>
    <nav class="space-y-1 text-sm">
      <a href="dashboard.html" class="sidebar-item">Dashboard</a>
      <a href="data-siswa.html" class="sidebar-item">Data Siswa</a>
      <a href="data-user.html" class="sidebar-item">Data User</a>
      <a href="daftar-nilai.html" class="sidebar-item">Daftar Nilai Harian</a>
      <a href="daftar-hadir.html" class="sidebar-item sidebar-active">Daftar Hadir Harian</a>
      <a href="jurnal.html" class="sidebar-item">Jurnal Mengajar</a>
      <a href="konseling.html" class="sidebar-item">Buku Konseling</a>
      <a href="modul.html" class="sidebar-item">Modul Ajar</a>
      <a href="index.html" class="sidebar-item text-red-500">Keluar Sistem</a>
    </nav>
  </aside>

  <main class="flex-1 p-8">
    <header class="mb-6 flex flex-wrap justify-between gap-3">
      <div>
        <h1 class="text-2xl font-bold text-slate-800">Rekap Kehadiran Harian (Guru)</h1>
        <p id="dateText" class="text-sm text-slate-500 mt-1"></p>
        <p class="text-xs text-slate-500 mt-2">Halaman ini hanya untuk rekap status hadir/izin/sakit/alfa dan pengiriman WA orang tua.</p>
      </div>
      <div class="flex gap-2">
        <button id="saveBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-semibold">Simpan Rekap</button>
        <button id="exportBtn" class="px-4 py-2 rounded-xl border border-slate-200 bg-white text-slate-700 font-semibold">Export Excel</button>
      </div>
    </header>

    <section class="bg-white border border-slate-100 rounded-2xl p-4 shadow-sm mb-5 grid grid-cols-1 md:grid-cols-3 gap-3">
      <label>
        <span class="text-xs font-bold text-slate-400 uppercase">Tanggal</span>
        <input id="attendanceDate" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 text-sm">
      </label>
      <label class="md:col-span-2">
        <span class="text-xs font-bold text-slate-400 uppercase">Cari Siswa</span>
        <input id="searchInput" type="text" placeholder="Nama / NISN..." class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 text-sm">
      </label>
    </section>

    <section class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
      <article class="bg-white border border-slate-100 rounded-2xl p-4 shadow-sm">
        <p class="text-xs text-slate-500 uppercase font-semibold">Hadir</p>
        <p id="countHadir" class="text-2xl font-bold text-emerald-600">0</p>
      </article>
      <article class="bg-white border border-slate-100 rounded-2xl p-4 shadow-sm">
        <p class="text-xs text-slate-500 uppercase font-semibold">Izin</p>
        <p id="countIzin" class="text-2xl font-bold text-amber-600">0</p>
      </article>
      <article class="bg-white border border-slate-100 rounded-2xl p-4 shadow-sm">
        <p class="text-xs text-slate-500 uppercase font-semibold">Sakit</p>
        <p id="countSakit" class="text-2xl font-bold text-cyan-600">0</p>
      </article>
      <article class="bg-white border border-slate-100 rounded-2xl p-4 shadow-sm">
        <p class="text-xs text-slate-500 uppercase font-semibold">Alfa</p>
        <p id="countAlfa" class="text-2xl font-bold text-rose-600">0</p>
      </article>
    </section>

    <section class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-slate-50 text-slate-500 uppercase text-xs tracking-wide">
            <tr>
              <th class="px-4 py-3 text-left">Nama</th>
              <th class="px-4 py-3 text-left">NISN</th>
              <th class="px-4 py-3 text-left">Status</th>
              <th class="px-4 py-3 text-left">Catatan</th>
              <th class="px-4 py-3 text-left">WA Orang Tua</th>
              <th class="px-4 py-3 text-right">Aksi</th>
            </tr>
          </thead>
          <tbody id="rows" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>
      <div id="emptyState" class="hidden p-8 text-center text-slate-500">Data siswa belum tersedia.</div>
    </section>
  </main>

  <div id="toast" class="hidden fixed bottom-5 right-5 bg-slate-900 text-white text-sm px-4 py-2 rounded-xl shadow-xl z-50"></div>

  <script>
    const STUDENT_KEY = "sd3_data_siswa_v1";
    const ATT_KEY = "sd3_presensi_v2";
    const defaultStudents = [
      { id: "STU-001", nisn: "1234567001", full_name: "Putu Ayu Lestari", parent_wa: "081234567001", is_active: true },
      { id: "STU-002", nisn: "1234567002", full_name: "Kadek Budi Santosa", parent_wa: "081234567002", is_active: true }
    ];

    const el = {
      date: document.getElementById("attendanceDate"),
      dateText: document.getElementById("dateText"),
      search: document.getElementById("searchInput"),
      saveBtn: document.getElementById("saveBtn"),
      exportBtn: document.getElementById("exportBtn"),
      rows: document.getElementById("rows"),
      empty: document.getElementById("emptyState"),
      toast: document.getElementById("toast"),
      countHadir: document.getElementById("countHadir"),
      countIzin: document.getElementById("countIzin"),
      countSakit: document.getElementById("countSakit"),
      countAlfa: document.getElementById("countAlfa")
    };

    let toastTimer = null;
    const students = loadArray(STUDENT_KEY, defaultStudents).filter(function (s) { return s.is_active !== false; });
    let attendances = loadArray(ATT_KEY, []);

    el.date.value = dateKey(new Date());
    refreshDateText();
    render();

    el.date.addEventListener("change", function () { refreshDateText(); render(); });
    el.search.addEventListener("input", render);
    el.saveBtn.addEventListener("click", saveRecap);
    el.exportBtn.addEventListener("click", exportExcel);

    function loadArray(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback.slice();
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed.filter(Boolean) : fallback.slice();
      } catch (error) {
        return fallback.slice();
      }
    }

    function persistAtt() {
      localStorage.setItem(ATT_KEY, JSON.stringify(attendances));
    }

    function dateKey(d) {
      const x = new Date(d);
      return x.getFullYear() + "-" + String(x.getMonth() + 1).padStart(2, "0") + "-" + String(x.getDate()).padStart(2, "0");
    }

    function esc(v) {
      return String(v || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function uid(prefix) {
      return prefix + "-" + Date.now().toString(36).toUpperCase() + "-" + Math.random().toString(36).slice(2, 6).toUpperCase();
    }

    function studentName(s) {
      return String((s && (s.full_name || s.name)) || "Tanpa Nama").trim();
    }

    function studentNisn(s) {
      return String((s && (s.nisn || s.nis)) || "").trim();
    }

    function studentWa(s) {
      return String((s && (s.parent_wa || s.wa)) || "").trim();
    }

    function normalizeStatus(value) {
      const v = String(value || "").trim().toLowerCase();
      if (v === "alpha") return "Alfa";
      if (v === "alfa") return "Alfa";
      if (v === "hadir") return "Hadir";
      if (v === "izin") return "Izin";
      if (v === "sakit") return "Sakit";
      return "Belum Absen";
    }

    function findRow(date, sid) {
      return attendances.find(function (a) { return a.date === date && a.student_id === sid; });
    }

    function upsertRow(row) {
      const idx = attendances.findIndex(function (a) { return a.date === row.date && a.student_id === row.student_id; });
      if (idx >= 0) attendances[idx] = row;
      else attendances.push(row);
    }

    function getFilteredStudents() {
      const query = String(el.search.value || "").trim().toLowerCase();
      return students
        .filter(function (s) {
          const nm = studentName(s).toLowerCase();
          const ns = studentNisn(s).toLowerCase();
          return !query || nm.includes(query) || ns.includes(query);
        })
        .sort(function (a, b) { return studentName(a).localeCompare(studentName(b), "id"); });
    }

    function statusOptions(selected) {
      const values = ["Belum Absen", "Hadir", "Izin", "Sakit", "Alfa"];
      return values.map(function (name) {
        return '<option value="' + esc(name) + '"' + (name === selected ? " selected" : "") + ">" + esc(name) + "</option>";
      }).join("");
    }

    function refreshDateText() {
      const value = el.date.value || dateKey(new Date());
      const d = new Date(value + "T00:00:00");
      el.dateText.textContent = d.toLocaleDateString("id-ID", {
        weekday: "long",
        day: "2-digit",
        month: "long",
        year: "numeric"
      });
    }

    function updateCounters(rowsByDate) {
      const counts = { hadir: 0, izin: 0, sakit: 0, alfa: 0 };
      rowsByDate.forEach(function (row) {
        const key = normalizeStatus(row.status).toLowerCase();
        if (counts[key] !== undefined) counts[key] += 1;
      });
      el.countHadir.textContent = String(counts.hadir);
      el.countIzin.textContent = String(counts.izin);
      el.countSakit.textContent = String(counts.sakit);
      el.countAlfa.textContent = String(counts.alfa);
    }

    function render() {
      const date = el.date.value || dateKey(new Date());
      const list = getFilteredStudents();
      const rowsByDate = attendances.filter(function (a) { return a.date === date; });
      const rowMap = new Map(rowsByDate.map(function (a) { return [a.student_id, a]; }));

      updateCounters(rowsByDate);

      if (!students.length) {
        el.rows.innerHTML = "";
        el.empty.textContent = "Data siswa belum tersedia.";
        el.empty.classList.remove("hidden");
        return;
      }

      if (!list.length) {
        el.rows.innerHTML = "";
        el.empty.textContent = "Siswa tidak ditemukan.";
        el.empty.classList.remove("hidden");
        return;
      }

      el.empty.classList.add("hidden");
      el.rows.innerHTML = list.map(function (student) {
        const row = rowMap.get(student.id) || {};
        const status = normalizeStatus(row.status);
        const wa = studentWa(student) || row.parent_wa || "-";
        return `
          <tr class="hover:bg-slate-50">
            <td class="px-4 py-3 font-semibold text-slate-800">${esc(studentName(student))}</td>
            <td class="px-4 py-3 text-slate-700">${esc(studentNisn(student) || "-")}</td>
            <td class="px-4 py-3">
              <select data-sid="${esc(student.id)}" class="status-input w-36 px-2 py-1 rounded-lg border border-slate-200 bg-white text-slate-700">
                ${statusOptions(status)}
              </select>
            </td>
            <td class="px-4 py-3">
              <input data-sid="${esc(student.id)}" class="note-input w-full min-w-[200px] px-2 py-1 rounded-lg border border-slate-200" value="${esc(row.notes || "")}" placeholder="Catatan tambahan">
            </td>
            <td class="px-4 py-3 text-slate-700">${esc(wa)}</td>
            <td class="px-4 py-3 text-right">
              <button data-sid="${esc(student.id)}" class="wa-btn px-3 py-1 rounded-lg border border-slate-200 bg-white text-slate-700 font-semibold">Kirim WA</button>
            </td>
          </tr>
        `;
      }).join("");

      const buttons = el.rows.querySelectorAll(".wa-btn");
      buttons.forEach(function (btn) {
        btn.addEventListener("click", function () {
          const sid = String(btn.getAttribute("data-sid") || "");
          const student = students.find(function (s) { return s.id === sid; });
          if (!student) return;
          const row = findRow(date, sid) || {
            date: date,
            student_id: student.id,
            student_name: studentName(student),
            nisn: studentNisn(student),
            parent_wa: studentWa(student),
            status: "Belum Absen",
            notes: ""
          };
          openWhatsApp(student, row);
        });
      });
    }

    function saveRecap() {
      const date = el.date.value || dateKey(new Date());
      const list = getFilteredStudents();
      if (!list.length) {
        toast("Tidak ada data untuk disimpan.");
        return;
      }

      let changed = 0;
      list.forEach(function (student) {
        const sid = student.id;
        const statusEl = el.rows.querySelector(".status-input[data-sid='" + cssEsc(sid) + "']");
        const noteEl = el.rows.querySelector(".note-input[data-sid='" + cssEsc(sid) + "']");
        if (!statusEl || !noteEl) return;

        const prev = findRow(date, sid);
        const row = prev || {
          id: uid("ATT"),
          date: date,
          student_id: sid,
          student_name: studentName(student),
          nisn: studentNisn(student),
          parent_wa: studentWa(student),
          status: "Belum Absen",
          notes: "",
          created_at: new Date().toISOString()
        };

        const nextStatus = normalizeStatus(statusEl.value);
        const nextNotes = String(noteEl.value || "").trim();
        if (!prev || row.status !== nextStatus || row.notes !== nextNotes) changed += 1;
        row.status = nextStatus;
        row.notes = nextNotes;
        row.updated_at = new Date().toISOString();
        upsertRow(row);
      });

      persistAtt();
      render();
      toast(changed ? (changed + " data rekap disimpan.") : "Tidak ada perubahan.");
    }

    function normalizeWaPhone(value) {
      const digits = String(value || "").replace(/[^\d]/g, "");
      if (!digits) return "";
      if (digits.startsWith("0")) return "62" + digits.slice(1);
      if (digits.startsWith("62")) return digits;
      return digits;
    }

    function makeWaMessage(student, row) {
      return "Yth. Orang Tua/Wali " + studentName(student) + ", " +
        "status kehadiran pada " + row.date + ": " + normalizeStatus(row.status) + ". " +
        "Catatan: " + (row.notes || "-") + ".";
    }

    function openWhatsApp(student, row) {
      const phone = normalizeWaPhone(studentWa(student) || row.parent_wa);
      if (!phone) {
        toast("Nomor WA orang tua belum diisi.");
        return;
      }
      const msg = makeWaMessage(student, row);
      const url = "https://wa.me/" + phone + "?text=" + encodeURIComponent(msg);
      const win = window.open(url, "_blank");
      if (!win) toast("Popup diblokir browser.");
    }

    function exportExcel() {
      if (typeof XLSX === "undefined") {
        toast("Library Excel tidak tersedia.");
        return;
      }
      const date = el.date.value || dateKey(new Date());
      const list = getFilteredStudents();
      if (!list.length) {
        toast("Tidak ada data untuk diekspor.");
        return;
      }
      const rows = list.map(function (student, index) {
        const row = findRow(date, student.id) || {};
        return {
          No: index + 1,
          Tanggal: date,
          NISN: studentNisn(student) || "-",
          Nama: studentName(student),
          Status: normalizeStatus(row.status),
          Catatan: row.notes || "",
          WA_Ortu: studentWa(student) || row.parent_wa || ""
        };
      });

      const sheet = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, sheet, "RekapKehadiran");
      XLSX.writeFile(wb, "rekap-kehadiran-" + date + ".xlsx");
      toast("Export Excel berhasil.");
    }

    function cssEsc(v) {
      return String(v || "").replace(/'/g, "\\'");
    }

    function toast(message) {
      el.toast.textContent = String(message || "");
      el.toast.classList.remove("hidden");
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(function () {
        el.toast.classList.add("hidden");
      }, 2000);
    }
  </script>
</body>
</html>
